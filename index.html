<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KING ADMIN - Codes</title>
  <style>
    body {
      background:#000;
      color:#0f0;
      font-family:Arial, sans-serif;
      margin:0;
      padding:20px;
      text-align:center;
    }
    h2 { margin-bottom:10px; }
    input, button { padding:8px; margin:5px; border:none; }
    input { text-align:center; }
    button { background:#0f0; color:#000; cursor:pointer; font-weight:bold; border-radius:8px; }
    button:hover { background:#3f3; }
    table { border-collapse:collapse; width:100%; margin-top:15px; }
    th, td { border:1px solid #0f0; padding:6px; text-align:center; }
    #visitsBox { margin-bottom:15px; font-size:16px; }

    /* شاشة تسجيل الدخول */
    #loginScreen {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.85);
      z-index:9999;
    }
    .loginCard {
      background:#050505;
      border:2px solid #0f0;
      padding:22px;
      width:320px;
      border-radius:12px;
    }
    .loginCard h3 { margin-top:0; margin-bottom:12px; color:#0f0; }

    /* ✅ تعديل الإدخال */
    .loginInput {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #0f0;
      background: transparent;
      color: #0f0;
      text-align: center;
      box-sizing: border-box;
    }

    .errorMsg { color:#ff4444; margin-top:8px; display:none; font-weight:bold; }

    .tgBtn {
      display:inline-block;
      margin-top:10px;
      padding:8px 12px;
      border-radius:8px;
      background:#0f0;
      color:#000;
      text-decoration:none;
      font-weight:bold;
    }
    .tgBtn:hover { background:#3f3; }

    #mainApp { display:none; }
  </style>
</head>
<body>

<!-- شاشة تسجيل الدخول -->
<div id="loginScreen">
  <div class="loginCard">
    <h3>تسجيل الدخول</h3>
    <p>أدخل كود التفعيل لتستمر</p>
    <input id="accessCode" class="loginInput" placeholder="أدخل الكود هنا"/>
    <div>
      <button id="loginBtn">دخول</button>
    </div>
    <div id="error" class="errorMsg">كود خطأ، تواصل مع المطور</div>
    <div style="margin-top:10px;">
      <a class="tgBtn" href="https://t.me/nbvvte" target="_blank">@Loty122</a>
    </div>
  </div>
</div>

<!-- المحتوى الرئيسي -->
<div id="mainApp">
  <h2>مرحبًا كينج</h2>
  <div id="visitsBox">
    عدد زياراتك المتبقية اليوم: <span id="visitsLeft">0</span>
  </div>

  <label>عدد الأكواد:</label>
  <input type="number" id="numCodes" value="5" min="1" max="100"><br>
  <label>عدد الاستخدامات لكل كود:</label>
  <input type="number" id="uses" value="1" min="1"><br>
  <button id="genBtn">توليد</button>
  <button id="clearBtn">مسح الكل</button>

  <h3>الأكواد المتاحة</h3>
  <table>
    <thead>
      <tr>
        <th>الكود</th>
        <th>الاستخدامات المتبقية</th>
      </tr>
    </thead>
    <tbody id="codesTable"></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const CORRECT_CODE = "449d4cba-c185-490f-8bfd-2cda209a0f80";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAF1K59iKFsVH-wyAKyGw2wsIMUIrT9WMg",
    authDomain: "admin-3fd30.firebaseapp.com",
    databaseURL: "https://admin-3fd30-default-rtdb.firebaseio.com",
    projectId: "admin-3fd30",
    storageBucket: "admin-3fd30.firebasestorage.app",
    messagingSenderId: "981773176798",
    appId: "1:981773176798:web:1ebc106e60af04ed8a174f",
    measurementId: "G-35L6036ED8"
  };

  const DAILY_VISITS = 100;
  let app, db;

  // شاشة الدخول
  const loginScreen = document.getElementById("loginScreen");
  const mainApp = document.getElementById("mainApp");
  const errorDiv = document.getElementById("error");
  document.getElementById("loginBtn").addEventListener("click", ()=>{
    const val = document.getElementById("accessCode").value.trim();
    if(val === CORRECT_CODE){
      loginScreen.style.display = "none";
      mainApp.style.display = "block";
      initFirebaseAndApp();
    } else {
      errorDiv.style.display = "block";
    }
  });

  function initFirebaseAndApp(){
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    document.getElementById("genBtn").addEventListener("click", generateCodes);
    document.getElementById("clearBtn").addEventListener("click", clearAll);
    initVisits();
    renderTable();
  }

  async function initVisits(){
    const snap = await get(ref(db, "visits"));
    let visitsLeft = DAILY_VISITS;

    if(snap.exists()){
      visitsLeft = snap.val().visitsLeft ?? DAILY_VISITS;
    } else {
      await set(ref(db, "visits"), { visitsLeft, lastReset: Date.now(), usedToday: false });
    }
    document.getElementById("visitsLeft").innerText = visitsLeft;
  }

  async function useVisits(count){
    const snap = await get(ref(db, "visits"));
    if(!snap.exists()) return false;
    let { visitsLeft } = snap.val();

    if(visitsLeft >= count){
      visitsLeft -= count;
      await set(ref(db, "visits"), { visitsLeft, lastReset: Date.now(), usedToday: true });
      document.getElementById("visitsLeft").innerText = visitsLeft;
      document.getElementById("visitsBox").style.color = "#0f0";
      return true;
    } else {
      document.getElementById("visitsLeft").innerText = "❌ انتهت الزيارات، برجاء انتظار المسؤول";
      document.getElementById("visitsBox").style.color = "red";
      return false;
    }
  }

  function randomHexCode(){
    const HEX = "0123456789ABCDEF";
    const parts = [];
    for(let g=0; g<4; g++){
      let seg = "";
      for(let i=0; i<5; i++) seg += HEX[Math.floor(Math.random()*HEX.length)];
      parts.push(seg);
    }
    return parts.join("-");
  }

  async function generateCodes(){
    const num = parseInt(document.getElementById("numCodes").value);
    const uses = parseInt(document.getElementById("uses").value);
    if(!await useVisits(num)) return;
    const snap = await get(ref(db, "codes"));
    const existing = new Set(snap.exists() ? Object.keys(snap.val()) : []);
    const newCodes = [];
    while(newCodes.length < num){
      const code = randomHexCode();
      if(!existing.has(code)){
        existing.add(code);
        newCodes.push(code);
      }
    }
    await Promise.all(newCodes.map(c => set(ref(db, "codes/" + c), { remaining: uses })));
    renderTable();
  }

  async function renderTable(){
    const snapshot = await get(ref(db, "codes"));
    const tbody = document.getElementById("codesTable");
    tbody.innerHTML = "";
    if(snapshot.exists()){
      const data = snapshot.val();
      Object.keys(data).sort().forEach(code=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${code}</td><td>${data[code].remaining}</td>`;
        tbody.appendChild(tr);
      });
    }
  }

  async function clearAll(){
    await remove(ref(db, "codes"));
    renderTable();
  }
</script>
</body>
</html>
